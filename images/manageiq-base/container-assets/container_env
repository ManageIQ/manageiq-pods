#!/bin/bash

[[ -s /etc/default/evm ]] && source /etc/default/evm

function urlescape() {
  PAYLOAD="$1" ruby --disable-gems -rcgi -e "puts CGI.escape(ENV['PAYLOAD'])"
}

safeuser=$(urlescape ${DATABASE_USER})
safepass=$(urlescape ${DATABASE_PASSWORD})
if [ -n "$safeuser" -a -n "$safepass" ]; then
  safeuserinfo="${safeuser}:${safepass}@"
else
  safeuserinfo=""
fi

database_url="postgresql://${safeuserinfo}${DATABASE_HOSTNAME:-localhost}:${DATABASE_PORT:-5432}/${DATABASE_NAME:-db_unknown}?encoding=utf8&pool=5&wait_timeout=5&sslmode=${DATABASE_SSL_MODE:-prefer}"
[[ -f /.postgresql/root.crt ]] && database_url="$database_url&sslrootcert=/.postgresql/root.crt"

export DATABASE_URL=$database_url
