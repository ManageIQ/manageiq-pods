#!/bin/bash

param_file=$1
[ -z "$param_file" ] && echo -e "Error: Missing argument. Usage:\n  $0 <parameters-file>" && exit 1

function apply_template() {
  local template=$1
  oc process -f templates/app/$template --param-file=$param_file --ignore-unknown-parameters | oc apply -f -
}

function secret_missing() {
  oc get secrets -o=name | grep -q "$1"
  [ $? -ne 0 ]
}

function parameter_provided() {
  grep -q "^$1=\S" $param_file
}

# For us to safely create the secret we need to have either provided a password
# or not have created the secret yet. This ensures we don't overwrite the existing
# password with a newly generated one.
(parameter_provided "DATABASE_PASSWORD" || secret_missing "postgresql-secrets") && apply_template "postgresql-secrets.yaml"
(parameter_provided "ENCRYPTION_KEY" || secret_missing "manageiq-secrets") && apply_template "manageiq-secrets.yaml"

# Orchestrator RBAC
oc apply -f templates/app/rbac.yaml

# Only deploy the database if the user didn't specify an external database host
parameter_provided "DATABASE_HOSTNAME" || apply_template "postgresql.yaml"

apply_template "httpd.yaml"
apply_template "memcached.yaml"
apply_template "orchestrator.yaml"
